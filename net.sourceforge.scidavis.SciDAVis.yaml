app-id: net.sourceforge.scidavis.SciDAVis
runtime: org.kde.Platform
sdk: org.kde.Sdk
runtime-version: '5.15'
command: scidavis
finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri
  #- --env=SESSION_MANAGER= # required to avoid Qt warning
  - --filesystem=home
  #- --env=PYTHON=python3 cmake .
  #- --env=PYTHONPATH=/app/packages/python
  #- --env=PYTHONPATH=/app/lib/python3.8/site-packages

modules:
  - shared-modules/glu/glu-9.json

  - name: muparser
    buildsystem: cmake
    cleanup:
      - /bin
    sources:
    - type: archive
      url: https://github.com/beltoforion/muparser/archive/v2.3.2.tar.gz
      sha256: b35fc84e3667d432e3414c8667d5764dfa450ed24a99eeef7ee3f6647d44f301   
      
  - name: python3-sip
    config-opts:
      - --sip-module=PyQt5.sip
      - --bindir=/app/bin
      - --destdir=/app/lib/python3.8/site-packages
      - --incdir=/app/include
      - --pyidir=/app/lib/python3.8/site-packages
      - --sipdir=/app/share/sip
      - --stubsdir=/app/lib/python3.8/site-packages
    sources:
      - type: archive
        url: https://sourceforge.net/projects/pyqt/files/sip/sip-4.19.13/sip-4.19.13.tar.gz
        sha256: e353a7056599bf5fbd5d3ff9842a6ab2ea3cf4e0304a0f925ec5862907c0d15e
  # Patch50
  # make install should not strip (by default)
      - type: patch
        path: sip-4.18-no_strip.patch
  #Patch51
  #try not to rpath the world
      - type: patch
        path: sip-4.18-no_rpath.patch
      - type: script
        commands:
          - processed="$( sed -e 's|--prefix=/app||' <<< "${@}" )";
          - python3 "configure.py" ${processed};
        dest-filename: configure
    cleanup:
      - /bin
 
  - name: python3-pyqt5
    config-opts:
      - --verbose
      - --confirm-license
      - --sip-incdir=/app/include
      - --bindir=/app/bin
      - --destdir=/app/lib/python3.8/site-packages
      - --designer-plugindir=/app/lib/plugins/designer
      - --qml-plugindir=/app/lib/plugins/PyQt5
      - --sipdir=/app/share/sip
      - --stubsdir=/app/lib/python3.8/site-packages/PyQt5
      - QMAKE_CFLAGS_RELEASE=-I/usr/include/python3.8/
      - QMAKE_CXXFLAGS_RELEASE=-I/usr/include/python3.8/
    build-options:
      env:
        QMAKEPATH: "/app/lib"
    sources:
      - type: archive
        url: https://sourceforge.net/projects/pyqt/files/PyQt5/PyQt-5.11.3/PyQt5_gpl-5.11.3.tar.gz
        sha256: c9b57d15601d436faf35dacf8e0acefa220194829a653e771e80b189b3261073
  #Patch1
  #support newer Qt5 releases than 5.11.2
      - type: patch
        path: PyQt5-Timeline.patch
      - type: script
        commands:
           - processed="$( sed -e 's|prefix|sysroot|' <<< "${@}" )";
           - python3 "configure.py" ${processed};
        dest-filename: configure
    cleanup:
      - /bin    
        
  - name: gsl
    config-opts:
      - --disable-static
    cleanup:
     - /bin
    sources:
      - type: archive
        url: https://ftp.gnu.org/gnu/gsl/gsl-2.6.tar.gz
        sha256: b782339fc7a38fe17689cb39966c4d821236c28018b6593ddb6fd59ee40786a8
        
  - name: scidavis        
    buildsystem: cmake
    config-opts:
         - -DSCRIPTING_PYTHON:BOOL=ON
         - -DORIGIN_IMPORT:BOOL=OFF
         - -DCMAKE_VERBOSE_MAKEFILE:BOOL=ON
         - -DPyQt_INCLUDE_DIR=/app/include/PyQt5
    sources:
      - type: git
        url: https://github.com/highperformancecoder/scidavis
        commit: faf0b7a37aaddb3b14a063fb431067c7236d7032 
